{"version":3,"sources":["ssr.js"],"names":["Ssr","constructor","dev","rootDir","distDir","Document","entryFiles","clientBundles","matchComponents","app","pathname","components","preload","routesList","map","routers","route","preloadFun","component","push","then","res","default","i","hasOwnProperty","Promise","all","catch","e","console","log","dispatchActions","parsedUrl","fetchList","bodyParam","getBodyParam","ctx","fetching","_store","props","isServerFetching","query","path","actionList","forEach","actions","action","debug","toString","prepare","Loadable","run","req","initDva","url","DApp","start","modules","C","module","bundles","html","renderDocument","page","files","children","err","code","statusCode","renderError","history","onError","message","router"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport * as Loadable from 'react-loadable';\nimport dva from 'dva';\nimport { createMemoryHistory } from 'history';\nimport { matchRoutes } from 'react-router-config';\nimport { getBundles } from 'react-loadable/webpack';\nimport router from '../router';\nimport { generateRoutes } from '../lib/routes';\nimport { renderToString } from 'react-dom/server';\nimport { sendHTML, registerModel } from '../lib/utils';\n\nexport default class Ssr {\n    constructor({\n        dev,\n        rootDir,\n        distDir,\n        Document,\n        entryFiles,\n        clientBundles\n    }) {\n        this.dev = dev;\n        this.rootDir = rootDir;\n        this.distDir = distDir;\n        this.Document = Document;\n        this.entryFiles = entryFiles;\n        this.clientBundles = clientBundles;\n        this.Loadable = Loadable;\n        this.routesList = generateRoutes();\n    }\n\n    matchComponents = async (app, pathname) => {\n      // 组件匹配（包含Loadable组件）\n      const components = [];\n      const preload = [];\n      matchRoutes(this.routesList, pathname).map((routers) => {\n          const route = routers.route;\n          const preloadFun = route.component['preload'];\n          if (!preloadFun) {\n              components.push(route.component);\n          } else {\n              preload.push(preloadFun().then(res => {\n                  if (res.default) {\n                      components.push(res.default);\n                  } else {\n                      for (let i in res) {\n                          if (res.hasOwnProperty(i)) {\n                              if (res[i].default.hasOwnProperty('namespace')) {\n                                  registerModel(app, res[i]);\n                              } else {\n                                  components.push(res[i].default);\n                              }\n                          }\n                      }\n                  }\n              }));\n          }\n      });\n\n      await Promise.all(preload).catch((e) => {\n          console.log('matchComponents error:', e);\n\n      });\n      return components;\n      \n    }\n\n    dispatchActions = async (app, components, parsedUrl) => {\n        // dispatch action\n        // 获取所有匹配组件的fetching方法\n        const fetchList = [];\n        let bodyParam = await getBodyParam(ctx, true);\n        components.map((component) => {  //tslint:disable-line\n            if (component.fetching) {\n                fetchList.push(component.fetching({\n                    ...app._store,\n                    ...component.props,\n                    isServerFetching: true, // 是否是服务端获取数据\n                    query: parsedUrl.query,\n                    path: parsedUrl.pathname\n                }));\n            }\n        });\n    \n        // 获取所有fetching方法中需要执行的action并过滤null\n        const actionList = [];\n        fetchList.forEach((actions) => {\n            (actions || []).forEach((action) => {\n                actionList.push(action);\n            });\n        });\n        // 执行所有action\n        await Promise.all(actionList).catch(e => {\n            debug('dispatchActions error:', e.toString());\n        });\n    }\n\n    prepare = async () => {\n        \n    }\n    \n    async run(\n        req,\n        res,\n        parsedUrl\n      ) {\n        this.initDva({url: req.url});\n        const app = this.app;\n        const DApp = app.start();\n        console.log('parsedUrl', parsedUrl);\n        const components = await this.matchComponents(app, parsedUrl.pathname);\n        await this.dispatchActions(app, components, parsedUrl)\n        try {\n          let modules = [];\n          const C = renderToString(\n              <Loadable.Capture report={module => { modules.push(module); }} >\n                  <DApp context={{\n                    routesList: this.routesList,\n                    Document: this.Document,\n                    app\n                  }} />\n              </Loadable.Capture>\n          );\n          \n          let bundles = getBundles(this.clientBundles, modules);\n          \n          const html = renderToString(this.Document.renderDocument(this.Document,\n              {\n                  page: parsedUrl.pathname,\n                  files: [...bundles, ...this.entryFiles],\n                  children: C\n              }\n          )\n          )\n          return sendHTML(req, res, html);\n        } catch (err) {\n          if (err.code === 'DECODE_FAILED') {\n            res.statusCode = 400\n            return this.renderError(null, req, res, '/_error', {})\n          }\n          throw err\n        }\n    \n        // await this.render404(req, res, parsedUrl)\n    }\n\n    initDva({url}) {\n        // 初始化DvaApp\n        const history = createMemoryHistory();\n        history.push(url);\n        \n        // let initialState = this.initLocale(this.initialState);\n\n        this.app = dva({history, onError: e => {\n            console.log(e.message);\n        }});\n        this.app.router(router);\n\n        // if (initModel.length) {\n        //     initModel.forEach(model => {\n        //         registerModel(this.app, model);\n        //     });\n        // }\n    }  \n}"]}