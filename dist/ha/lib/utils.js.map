{"version":3,"sources":["utils.js"],"names":["printAndExit","message","code","console","log","error","process","exit","getNodeOptionsWithoutInspect","NODE_INSPECT_RE","env","NODE_OPTIONS","replace","hasNamespace","model","namespace","filter","item","length","registerModel","app","default","_models","registerModels","modelList","forEach","ESCAPE_LOOKUP","ESCAPE_REGEX","htmlEscapeJsonString","str","match","loadGetInitialProps","App","ctx","NODE_ENV","prototype","getInitialProps","getDisplayName","Error","res","Component","pageProps","props","isResSent","Object","keys","warn","getPagePath","page","distDir","server","serverBuildPath","path","join","pagesManifest","require","PAGES_MANIFEST","requirePage","BLOCKED_PAGES_REG","test","pagePath","Array","isArray","comPath","modelPath","langPath","filePath","langModule","modelModule","state","_Lang","sendHTML","req","html","getHeader","setHeader","Buffer","byteLength","end","method"],"mappings":"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","sourcesContent":["import path from 'path';\n\nimport { PAGES_MANIFEST, BLOCKED_PAGES_REG } from './constants';\n\n\nexport function printAndExit(message, code = 1) {\n    if (code === 0) {\n      // tslint:disable-next-line no-console\n      console.log(message)\n    } else {\n      console.error(message)\n    }\n  \n    process.exit(code)\n  }\n  \nexport function getNodeOptionsWithoutInspect() {\n  const NODE_INSPECT_RE = /--inspect(-brk)?(=\\S+)?( |$)/\n  return (process.env.NODE_OPTIONS || '').replace(NODE_INSPECT_RE, '')\n}\n\nfunction hasNamespace (model = [], namespace) {\n  return model.filter(item => {\n    return item.namespace === namespace;\n  }).length > 0;\n}\n\nexport function registerModel(app, model) {\n model = model.default || model;\n if (!hasNamespace(app._models, model.namespace)) {\n   app.model(model);\n }\n}\n\nexport function registerModels (app, modelList) {\n  modelList.forEach(model => {\n      registerModel(app, model);\n  });\n};\n\nconst ESCAPE_LOOKUP = {\n  '&': '\\\\u0026',\n  '>': '\\\\u003e',\n  '<': '\\\\u003c',\n  '\\u2028': '\\\\u2028',\n  '\\u2029': '\\\\u2029',\n}\n\nconst ESCAPE_REGEX = /[&><\\u2028\\u2029]/g\n\nexport function htmlEscapeJsonString(str) {\n  return str.replace(ESCAPE_REGEX, (match) => ESCAPE_LOOKUP[match])\n}\n\nexport async function loadGetInitialProps (App, ctx) {\n  if (process.env.NODE_ENV !== 'production') {\n    if (App.prototype?.getInitialProps) {\n      const message = `\"${getDisplayName(\n        App\n      )}.getInitialProps()\" is defined as an instance method - visit https://err.sh/zeit/next.js/get-initial-props-as-an-instance-method for more information.`\n      throw new Error(message)\n    }\n  }\n  // when called from _app `ctx` is nested in `ctx`\n  const res = ctx.res || (ctx.ctx && ctx.ctx.res)\n\n  if (!App.getInitialProps) {\n    if (ctx.ctx && ctx.Component) {\n      // @ts-ignore pageProps default\n      return {\n        pageProps: await loadGetInitialProps(ctx.Component, ctx.ctx),\n      }\n    }\n    return {}\n  }\n\n  const props = await App.getInitialProps(ctx)\n\n  if (res && isResSent(res)) {\n    return props\n  }\n\n  if (!props) {\n    const message = `\"${getDisplayName(\n      App\n    )}.getInitialProps()\" should resolve to an object. But found \"${props}\" instead.`\n    throw new Error(message)\n  }\n\n  if (process.env.NODE_ENV !== 'production') {\n    if (Object.keys(props).length === 0 && !ctx.ctx) {\n      console.warn(\n        `${getDisplayName(\n          App\n        )} returned an empty object from \\`getInitialProps\\`. This de-optimizes and prevents automatic static optimization. https://err.sh/zeit/next.js/empty-object-getInitialProps`\n      )\n    }\n  }\n\n  return props\n}\n\nexport function getPagePath (page, distDir, server) {\n  const serverBuildPath = path.join(distDir, server);\n  const pagesManifest = require(path.join(serverBuildPath, PAGES_MANIFEST))\n  return  pagesManifest[page];\n}\n\nexport async function requirePage(app, page, distDir, server) {\n  console.log('page', page);\n  const serverBuildPath = path.join(distDir, server);\n  if (BLOCKED_PAGES_REG.test(page)) {\n    return require(path.join(serverBuildPath, page))\n  }\n  const pagePath = getPagePath(page, distDir, server)\n  if (Array.isArray(pagePath)) {\n    let comPath = null,\n        modelPath = null,\n        langPath = null;\n    for (const filePath of pagePath) {\n      if (/aModel\\.js$/.test(filePath)) {\n        modelPath = path.join(serverBuildPath, filePath);\n      } else if (/aLang\\.js$/.test(filePath)) {\n        langPath = path.join(serverBuildPath, filePath)\n      } else if (/aIndex\\.js$/.test(filePath)) {\n        comPath = path.join(serverBuildPath, filePath);\n      } else {\n\n      }\n    }\n    console.log('modelPath', modelPath);\n    \n    const langModule = require(langPath)\n    const modelModule = require(modelPath)\n    console.log('modelModule', modelModule);\n    \n    const model = modelModule.default || modelModule;\n    model.state._Lang = langModule.default || langModule;\n    registerModel(app, model.default || model);\n    return require(comPath);\n  }\n}\n  \n\nexport function sendHTML(\n  req,\n  res,\n  html\n) {\n\n  if (!res.getHeader('Content-Type')) {\n    res.setHeader('Content-Type', 'text/html; charset=utf-8')\n  }\n  res.setHeader('Content-Length', Buffer.byteLength(html))\n  res.end(req.method === 'HEAD' ? null : html)\n}"]}