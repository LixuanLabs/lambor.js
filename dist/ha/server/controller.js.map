{"version":3,"sources":["controller.js"],"names":["Controller","preload","ssr","Loadable","preloadAll","handleRequest","req","res","parsedUrl","url","console","log","pathname","dev","hotReloader","run","haCon","apiReg","test","end","startsWith","write","mfs","readFileSync","distDir","slice","length","fs","query","err","error","statusCode","init","dir","conf","rootDir","Document","entryFiles","Ssr","clientBundles","require","REACT_LOADABLE_MANIFEST","SERVER_DIRECTORY","DOCUMENTJS","default","ENTRY_FILES","SERVEROUTPUT"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { join, resolve } from 'path';\nimport fs from 'fs';\nimport { parse as parseQs, ParsedUrlQuery } from 'querystring'\nimport { parse as parseUrl } from 'url'\nimport loadConfig from './config'\nimport { ENTRY_FILES, REACT_LOADABLE_MANIFEST, SERVER_DIRECTORY, DOCUMENTJS, SERVEROUTPUT } from '../lib/constants';\nimport build from '../build';\n\nexport default class Controller {\n    async init({\n      dir = '.',\n      conf = null,\n      dev = false\n    }) {\n      const rootDir = resolve(dir);\n      this.dev = dev;\n      this.haCon = loadConfig(rootDir, conf);\n      this.distDir = join(rootDir, this.haCon.distDir);\n      if (dev) {\n        const { \n          Document,\n          entryFiles,\n          Ssr,\n          clientBundles,\n          mfs,\n          hotReloader\n        } = await build(rootDir, {dev});\n        this.clientBundles = clientBundles;\n        this.Document = Document;\n        this.entryFiles = entryFiles;\n        this.Ssr = Ssr;\n        this.mfs = mfs;\n        this.hotReloader = hotReloader;\n      } else {\n        this.clientBundles = require(join(this.distDir, REACT_LOADABLE_MANIFEST));\n        this.Document = require(join(this.distDir, SERVER_DIRECTORY, DOCUMENTJS)).default;\n        this.entryFiles = require(join(this.distDir, ENTRY_FILES)).default;\n        this.Ssr = require(join(this.distDir, SERVER_DIRECTORY, SERVEROUTPUT)).default;\n      }\n      this.ssr = new this.Ssr({\n        rootDir,\n        distDir: this.distDir,\n        Document: this.Document,\n        entryFiles: this.entryFiles,\n        clientBundles: this.clientBundles\n      });\n    }\n\n    preload = async () => {\n      await this.ssr.Loadable.preloadAll();\n    }\n\n    handleRequest = async (req, res, parsedUrl) => {\n        if (!parsedUrl || typeof parsedUrl !== 'object') {\n          parsedUrl = parseUrl(req.url, true)\n        }\n        console.log('parsedUrl.pathname', parsedUrl.pathname);\n        if (this.dev) {\n          await this.hotReloader.run(req, res, parsedUrl);\n        }\n        console.log('执行');\n\n        // 检测是否为数据请求\n        if (this.haCon.apiReg.test(parsedUrl.pathname)) {\n            console.log('api接口', parsedUrl.pathname);\n            res.end();\n            return;\n        }\n\n        // 是否为静态文件\n        if (parsedUrl.pathname.startsWith('/dist')) {\n          if (this.dev) {\n            res.write(\n              this.mfs.readFileSync(\n                join(\n                  this.distDir,\n                  parsedUrl.pathname.slice('/dist/'.length)\n                ),\n                'utf8'\n              )\n            )\n          } else {\n            res.write(\n              fs.readFileSync(\n                join(\n                  this.distDir,\n                  parsedUrl.pathname.slice('/dist/'.length)\n                ),\n                'utf8'\n              )\n            )\n          }\n          return res.end()\n        }\n\n        if (parsedUrl.pathname === '/favicon.ico') {\n          res.end();\n          return;\n        }\n    \n        // Parse the querystring ourselves if the user doesn't handle querystring parsing\n        if (typeof parsedUrl.query === 'string') {\n          parsedUrl.query = parseQs(parsedUrl.query)\n        }\n\n    \n        try {\n          return await this.ssr.run(req, res, parsedUrl)\n        } catch (err) {\n          console.error(err)\n          res.statusCode = 500\n          res.end('Internal Server Error')\n        }\n    }\n    \n}"]}